---

#####################################
# Install Cluster overprovisioner via helm
#####################################

- name: Set replicaCount variable
  set_fact: 
    replicaCount: 1
  when: replicaCount is undefined or replicaCount =="auto"

- name: Set resources_limitss_cpu variable
  block: 
    - ec2_instance_facts:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "nodes.{{ cluster_name }}"
      register: ec2if
 
    - set_fact:
        resources_limitss_cpu: "{{ ec2if.instances[0].cpu_options.core_count * ec2if.instances[0].cpu_options.threads_per_core * 0.75 }}"

  when: resources_limitss_cpu is undefined or resources_limitss_cpu =="auto"

- name: Adding Cluster overprovisioner via Helm
  shell: |
    helm install --atomic --dep-up --timeout=600 \
    --namespace kube-system-cluster \
    --name cluster-overprovisioner \
    --set deployments[0].name=nodes \
    --set deployments[0].replicaCount="{{ replicaCount }}" \
    --set deployments[0].resources.limits.cpu="{{ resources_limitss_cpu }}" \
    stable/cluster-overprovisioner
