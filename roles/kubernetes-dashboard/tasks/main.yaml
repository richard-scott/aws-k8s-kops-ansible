---

########################################
# Install Kubernetes Dashboard & Ingress
########################################

- name: Install Kubernetes Dashboard
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended.yaml
  args:
    executable: /bin/bash

- name: Add a Dashboard Admin user account
  shell: |
    kubectl create -f {{ role_path }}/files/{{item}}.yaml
  args:
    executable: /bin/bash
  ignore_errors: true
  with_items:
    - ServiceAccount
    - ClusterRoleBinding

- import_role:
    name: helm-nginx-ingress
  vars:
    namespace: kubernetes-dashboard

- name: "Setup Kubernetes Dashboard Ingress at kubernetes-dashboard.{{ dns_zone }}"
  shell: |
    echo "{{ lookup( 'template', 'template/dashboard-ingress.yaml.j2') }}" | kubectl apply -f -
  args:
    executable: /bin/bash

- name: "Waiting for DNS to update on kubernetes-dashboard.{{ dns_zone }}"
  shell: |
    dig +short kubernetes-dashboard.{{ dns_zone }} | egrep -v "^$"
  args:
    executable: /bin/bash
  register: cmd_result
  until: cmd_result.rc == 0
  retries: 30
  delay: 60

- name: "Waiting for Load Balancer to settle"
  uri:
    url: "https://kubernetes-dashboard.{{ dns_zone }}/"
    validate_certs: no
    timeout: 900
  register: result
  until: result.elapsed is defined
  retries: 30
  delay: 60  
